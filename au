<?php
require_once 'config.php';

// Проверяем авторизацию администратора
session_start();
if (!isset($_SESSION['user_id']) || $_SESSION['user_role'] !== 'admin') {
    die('Доступ запрещен. Только администратор может запустить этот скрипт.');
}

// Подключаем функции базы данных
if (!file_exists('includes/database.php')) {
    die('Ошибка: Файл database.php не найден');
}
require_once 'includes/database.php';

// Получаем всех пользователей с незахэшированными паролями
$users = db_fetch_all("SELECT id, username, password FROM users WHERE password NOT LIKE '$2y$%'");

if (empty($users)) {
    echo "Все пароли уже хэшированы.<br>";
    echo "Количество пользователей: " . count($users) . "<br>";
} else {
    echo "Найдено " . count($users) . " пользователей с незахэшированными паролями:<br><br>";
    
    $updated_count = 0;
    foreach ($users as $user) {
        echo "Обработка пользователя: {$user['username']} (ID: {$user['id']})<br>";
        echo "Текущий пароль: {$user['password']}<br>";
        
        // Хэшируем пароль
        $hashed_password = password_hash($user['password'], PASSWORD_BCRYPT);
        
        // Обновляем в базе
        $result = db_query("UPDATE users SET password = ? WHERE id = ?", [
            $hashed_password,
            $user['id']
        ]);
        
        if ($result) {
            echo "Пароль хэширован и обновлен<br><br>";
            $updated_count++;
        } else {
            echo "Ошибка при обновлении пароля<br><br>";
        }
    }
    
    echo "Всего обновлено: {$updated_count} пользователей<br>";
}

// Также создаем демо-пользователей, если их нет
echo "<br><br>Создание демо-пользователей, если их нет...<br>";

$demo_users = [
    [
        'username' => 'admin',
        'password' => 'admin123',
        'full_name' => 'Администратор Системы',
        'email' => 'admin@example.com',
        'role' => 'admin',
        'phone' => '+7 (999) 123-45-67'
    ],
    [
        'username' => 'manager',
        'password' => 'manager123',
        'full_name' => 'Менеджер Склада',
        'email' => 'manager@example.com',
        'role' => 'manager',
        'phone' => '+7 (999) 234-56-78'
    ],
    [
        'username' => 'ivanov',
        'password' => 'storekeeper123',
        'full_name' => 'Иванов Иван Иванович',
        'email' => 'ivanov@example.com',
        'role' => 'storekeeper',
        'phone' => '+7 (999) 345-67-89'
    ]
];

foreach ($demo_users as $demo_user) {
    // Проверяем существование пользователя
    $existing = db_fetch_one("SELECT id FROM users WHERE username = ?", [$demo_user['username']]);
    
    if (!$existing) {
        // Хэшируем пароль
        $hashed_password = password_hash($demo_user['password'], PASSWORD_BCRYPT);
        
        // Создаем пользователя
        $user_id = db_insert('users', [
            'username' => $demo_user['username'],
            'password' => $hashed_password,
            'full_name' => $demo_user['full_name'],
            'email' => $demo_user['email'],
            'role' => $demo_user['role'],
            'phone' => $demo_user['phone'],
            'is_active' => 1,
            'created_at' => date('Y-m-d H:i:s')
        ]);
        
        echo "Создан пользователь: {$demo_user['username']}<br>";
    } else {
        echo "Пользователь {$demo_user['username']} уже существует<br>";
    }
}

echo "<br><br>Готово! Теперь можно войти с демо-доступами:<br>";
echo "admin / admin123<br>";
echo "manager / manager123<br>";
echo "ivanov / storekeeper123<br>";
?>