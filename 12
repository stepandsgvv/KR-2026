<?php
/**
 * Функции аутентификации
 */

if (!function_exists('authenticate_user')) {
    /**
     * Авторизация пользователя
     * @param string $username Имя пользователя
     * @param string $password Пароль
     * @return array Результат авторизации
     */
    function authenticate_user($username, $password) {
        // Проверяем количество попыток входа
        if (!check_login_attempts($username)) {
            return [
                'success' => false,
                'message' => 'Слишком много неудачных попыток входа. Попробуйте через 15 минут.'
            ];
        }
        
        // Ищем пользователя по имени
        $user = db_fetch_one("
            SELECT id, username, password, full_name, email, role, is_active 
            FROM users 
            WHERE username = ?
        ", [$username]);
        
        if (!$user) {
            log_login_attempt($username, false);
            return [
                'success' => false,
                'message' => 'Неверное имя пользователя или пароль'
            ];
        }
        
        if (!$user['is_active']) {
            log_login_attempt($username, false);
            return [
                'success' => false,
                'message' => 'Учетная запись отключена'
            ];
        }
        
        // Проверяем пароль
        if (!password_verify($password, $user['password'])) {
            log_login_attempt($username, false);
            return [
                'success' => false,
                'message' => 'Неверное имя пользователя или пароль'
            ];
        }
        
        // Если пароль хэширован старым алгоритмом, обновляем его
        if (password_needs_rehash($user['password'], PASSWORD_BCRYPT)) {
            $new_hash = password_hash($password, PASSWORD_BCRYPT);
            db_query("UPDATE users SET password = ? WHERE id = ?", [
                $new_hash,
                $user['id']
            ]);
        }
        
        // Успешная авторизация
        log_login_attempt($username, true);
        
        // Устанавливаем сессию
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['username'] = $user['username'];
        $_SESSION['full_name'] = $user['full_name'];
        $_SESSION['user_role'] = $user['role'];
        $_SESSION['login_time'] = time();
        $_SESSION['last_activity'] = time();
        
        // Обновляем время последнего входа
        db_query("UPDATE users SET last_login = NOW() WHERE id = ?", [$user['id']]);
        
        return [
            'success' => true,
            'message' => 'Авторизация успешна'
        ];
    }
}

if (!function_exists('create_user')) {
    /**
     * Создание нового пользователя
     * @param array $user_data Данные пользователя
     * @return array Результат создания
     */
    function create_user($user_data) {
        // Валидация данных
        $errors = [];
        
        if (empty($user_data['username'])) {
            $errors[] = 'Имя пользователя обязательно';
        }
        
        if (empty($user_data['password'])) {
            $errors[] = 'Пароль обязателен';
        }
        
        if (empty($user_data['full_name'])) {
            $errors[] = 'Полное имя обязательно';
        }
        
        if (empty($user_data['email'])) {
            $errors[] = 'Email обязателен';
        } elseif (!filter_var($user_data['email'], FILTER_VALIDATE_EMAIL)) {
            $errors[] = 'Неверный формат email';
        }
        
        if (empty($user_data['role'])) {
            $errors[] = 'Роль обязательна';
        }
        
        // Проверка уникальности имени пользователя
        $existing = db_fetch_one("SELECT id FROM users WHERE username = ?", [$user_data['username']]);
        if ($existing) {
            $errors[] = 'Пользователь с таким именем уже существует';
        }
        
        // Проверка уникальности email
        $existing = db_fetch_one("SELECT id FROM users WHERE email = ?", [$user_data['email']]);
        if ($existing) {
            $errors[] = 'Пользователь с таким email уже существует';
        }
        
        if (!empty($errors)) {
            return [
                'success' => false,
                'errors' => $errors
            ];
        }
        
        // Хэшируем пароль
        $hashed_password = password_hash($user_data['password'], PASSWORD_BCRYPT);
        
        // Создаем пользователя
        $user_id = db_insert('users', [
            'username' => $user_data['username'],
            'password' => $hashed_password,
            'full_name' => $user_data['full_name'],
            'email' => $user_data['email'],
            'role' => $user_data['role'],
            'phone' => $user_data['phone'] ?? null,
            'is_active' => 1,
            'created_at' => date('Y-m-d H:i:s')
        ]);
        
        if ($user_id) {
            log_action('USER_CREATE', "Создан пользователь: {$user_data['username']}");
            return [
                'success' => true,
                'user_id' => $user_id,
                'message' => 'Пользователь успешно создан'
            ];
        }
        
        return [
            'success' => false,
            'errors' => ['Ошибка при создании пользователя']
        ];
    }
}

if (!function_exists('update_user_password')) {
    /**
     * Обновление пароля пользователя
     * @param int $user_id ID пользователя
     * @param string $new_password Новый пароль
     * @param string $current_password Текущий пароль (для проверки)
     * @param bool $admin_override Администратор может менять без текущего пароля
     * @return array Результат обновления
     */
    function update_user_password($user_id, $new_password, $current_password = null, $admin_override = false) {
        // Получаем текущий пароль
        $user = db_fetch_one("SELECT password, role FROM users WHERE id = ?", [$user_id]);
        
        if (!$user) {
            return [
                'success' => false,
                'message' => 'Пользователь не найден'
            ];
        }
        
        // Проверяем текущий пароль, если не администратор
        if (!$admin_override) {
            if (!$current_password || !password_verify($current_password, $user['password'])) {
                return [
                    'success' => false,
                    'message' => 'Неверный текущий пароль'
                ];
            }
        }
        
        // Хэшируем новый пароль
        $hashed_password = password_hash($new_password, PASSWORD_BCRYPT);
        
        // Обновляем пароль
        $updated = db_query("UPDATE users SET password = ? WHERE id = ?", [
            $hashed_password,
            $user_id
        ]);
        
        if ($updated) {
            log_action('PASSWORD_CHANGE', "Изменен пароль пользователя ID: $user_id");
            return [
                'success' => true,
                'message' => 'Пароль успешно изменен'
            ];
        }
        
        return [
            'success' => false,
            'message' => 'Ошибка при изменении пароля'
        ];
    }
}

if (!function_exists('reset_password_request')) {
    /**
     * Запрос на сброс пароля
     * @param string $email Email пользователя
     * @return array Результат запроса
     */
    function reset_password_request($email) {
        // Проверяем существование пользователя
        $user = db_fetch_one("SELECT id, username, full_name FROM users WHERE email = ? AND is_active = 1", [$email]);
        
        if (!$user) {
            // Возвращаем успех даже если пользователь не найден (безопасность)
            return [
                'success' => true,
                'message' => 'Если пользователь с таким email существует, инструкции отправлены'
            ];
        }
        
        // Генерируем токен
        $token = bin2hex(random_bytes(32));
        $expires_at = date('Y-m-d H:i:s', strtotime('+1 hour'));
        
        // Сохраняем токен
        db_query("
            INSERT INTO password_resets (email, token, expires_at) 
            VALUES (?, ?, ?) 
            ON DUPLICATE KEY UPDATE token = ?, expires_at = ?
        ", [$email, $token, $expires_at, $token, $expires_at]);
        
        // Здесь должна быть отправка email с токеном
        // В демо-версии просто возвращаем токен
        
        log_action('PASSWORD_RESET_REQUEST', "Запрос сброса пароля для: $email");
        
        return [
            'success' => true,
            'message' => 'Инструкции по сбросу пароля отправлены на email',
            'token' => $token, // В продакшене не возвращаем
            'reset_url' => SITE_URL . "/reset_password.php?token=" . $token
        ];
    }
}

if (!function_exists('reset_password_confirm')) {
    /**
     * Подтверждение сброса пароля
     * @param string $token Токен сброса
     * @param string $new_password Новый пароль
     * @return array Результат сброса
     */
    function reset_password_confirm($token, $new_password) {
        // Проверяем токен
        $reset = db_fetch_one("
            SELECT email, expires_at 
            FROM password_resets 
            WHERE token = ? AND expires_at > NOW()
        ", [$token]);
        
        if (!$reset) {
            return [
                'success' => false,
                'message' => 'Неверный или просроченный токен'
            ];
        }
        
        // Находим пользователя
        $user = db_fetch_one("SELECT id FROM users WHERE email = ?", [$reset['email']]);
        
        if (!$user) {
            return [
                'success' => false,
                'message' => 'Пользователь не найден'
            ];
        }
        
        // Хэшируем новый пароль
        $hashed_password = password_hash($new_password, PASSWORD_BCRYPT);
        
        // Обновляем пароль
        $updated = db_query("UPDATE users SET password = ? WHERE email = ?", [
            $hashed_password,
            $reset['email']
        ]);
        
        if ($updated) {
            // Удаляем использованный токен
            db_query("DELETE FROM password_resets WHERE token = ?", [$token]);
            
            log_action('PASSWORD_RESET_COMPLETE', "Сброс пароля для: {$reset['email']}");
            
            return [
                'success' => true,
                'message' => 'Пароль успешно изменен'
            ];
        }
        
        return [
            'success' => false,
            'message' => 'Ошибка при изменении пароля'
        ];
    }
}

if (!function_exists('validate_password_strength')) {
    /**
     * Проверка сложности пароля
     * @param string $password Пароль
     * @return array Результат проверки
     */
    function validate_password_strength($password) {
        $errors = [];
        
        if (strlen($password) < 8) {
            $errors[] = 'Минимальная длина пароля - 8 символов';
        }
        
        if (!preg_match('/[A-Z]/', $password)) {
            $errors[] = 'Пароль должен содержать хотя бы одну заглавную букву';
        }
        
        if (!preg_match('/[a-z]/', $password)) {
            $errors[] = 'Пароль должен содержать хотя бы одну строчную букву';
        }
        
        if (!preg_match('/[0-9]/', $password)) {
            $errors[] = 'Пароль должен содержать хотя бы одну цифру';
        }
        
        return [
            'valid' => empty($errors),
            'errors' => $errors
        ];
    }
}

if (!function_exists('logout')) {
    /**
     * Выход пользователя
     */
    function logout() {
        // Логируем выход
        log_action('USER_LOGOUT', 'Выход из системы', $_SESSION['user_id'] ?? null);
        
        // Очищаем сессию
        $_SESSION = [];
        
        // Удаляем сессионную cookie
        if (ini_get("session.use_cookies")) {
            $params = session_get_cookie_params();
            setcookie(session_name(), '', time() - 42000,
                $params["path"], $params["domain"],
                $params["secure"], $params["httponly"]
            );
        }
        
        // Уничтожаем сессию
        session_destroy();
    }
}

if (!function_exists('get_current_user_data')) {
    /**
     * Получение данных текущего пользователя
     * @return array|null Данные пользователя
     */
    function get_current_user_data() {
        if (!isset($_SESSION['user_id'])) {
            return null;
        }
        
        return db_fetch_one("
            SELECT id, username, email, role, full_name, phone, created_at, last_login 
            FROM users 
            WHERE id = ? 
            LIMIT 1
        ", [$_SESSION['user_id']]);
    }
}

if (!function_exists('get_role_permissions')) {
    /**
     * Получение разрешений для роли
     * @param string $role Роль пользователя
     * @return array Массив разрешений
     */
    function get_role_permissions($role) {
        $permissions = [
            'admin' => [
                'view_dashboard',
                'manage_users',
                'manage_products',
                'manage_categories',
                'view_reports',
                'manage_settings',
                'view_logs',
                'manage_transactions',
                'manage_storage'
            ],
            'manager' => [
                'view_dashboard',
                'manage_products',
                'manage_categories',
                'view_reports',
                'view_logs',
                'manage_transactions',
                'manage_storage'
            ],
            'storekeeper' => [
                'view_dashboard',
                'view_products',
                'manage_transactions',
                'view_storage'
            ],
            'viewer' => [
                'view_dashboard',
                'view_products',
                'view_reports',
                'view_storage'
            ]
        ];
        
        return $permissions[$role] ?? [];
    }
}

if (!function_exists('has_permission')) {
    /**
     * Проверка разрешений пользователя
     * @param string $permission Требуемое разрешение
     * @return bool
     */
    function has_permission($permission) {
        if (!isset($_SESSION['user_role'])) {
            return false;
        }
        
        $permissions = get_role_permissions($_SESSION['user_role']);
        return in_array($permission, $permissions);
    }
}
?>
